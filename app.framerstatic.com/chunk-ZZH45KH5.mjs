import{a as Se,b as we}from"https://app.framerstatic.com/chunk-C25CXIAS.mjs";import{b as z,d as Ne,f as Pe}from"https://app.framerstatic.com/chunk-WRTBVKKU.mjs";import{b as Re,e as D}from"https://app.framerstatic.com/chunk-OTIFPWYF.mjs";import{b as De,c as Le,d as xe}from"https://app.framerstatic.com/chunk-SE354WOV.mjs";import{a as Ee}from"https://app.framerstatic.com/chunk-M77ZNLMM.mjs";import{Ag as B,Q as ee,ig as V,rd as Te,sg as be,ug as te,vg as re,wg as ne,xg as C,yg as se}from"https://app.framerstatic.com/chunk-FEMUQY7R.mjs";import{f as Ce}from"https://app.framerstatic.com/chunk-XBM64GTP.mjs";import{Br as ve,Cr as Z,Dr as ye,la as ue,lm as fe,ub as ge,yb as pe}from"https://app.framerstatic.com/chunk-Q5MQYIKV.mjs";import{p as U}from"https://app.framerstatic.com/chunk-RJOTTV32.mjs";import{d as me,i as I}from"https://app.framerstatic.com/chunk-ZQUNXESX.mjs";import{a as Je}from"https://app.framerstatic.com/chunk-BWUNBOFS.mjs";import{g as O}from"https://app.framerstatic.com/chunk-4CB4BQFV.mjs";import{da as he,e as le,ea as A,u as v}from"https://app.framerstatic.com/chunk-IZV4HDYJ.mjs";import{a as h,b as ce}from"https://app.framerstatic.com/chunk-WNSBRACC.mjs";import{e as Ge,j as d}from"https://app.framerstatic.com/chunk-AHQIRSXG.mjs";var $e=v("DocumentLoader"),ie=v("remote:verify"),q=class o{constructor(t,e){this.parser=t;this.settings=e;d(this,"canvasTreeVersion",0);d(this,"chunkingHints");this.canvasTreeVersion=this.parser.version,this.chunkingHints=this.parser.getChunkingHints()}static async createPartialParser(t,e){if(typeof t=="string"){let r=new Le(t);return new o(r,e)}else{let r=new xe(t);return new o(r,e)}}readFirstPage(){let t=!1,e=[];if(this.settings.activeNodeId&&(e.push(...this.parser.getPagesContainingId(this.settings.activeNodeId)),t=e.some(r=>we(this.parser.getShallowPage(r)))),!t){let r=Se(this.parser.getShallowPages(),this.parser.getHomePageNodeID());e.push(r.id)}return $e.debug("loadPartialDocument():",e),Pe(this.parser,e,this.settings.treeServices)}getScopesToLoad(){return this.parser.getPagesToLoad()}getParsedPageById(t){return this.parser.getParsedPageById(t)}buildPage(t){if(!t)return;let e=[],r=ie.isLoggingTraceMessages()?[]:void 0,n=V(t,this.parser.root.id,{extraChecksAndFixes:!0,errors:e,warnings:r});if(n&&Ne(n,e),e.length>0&&ie.warn("errors loading server tree: "+e.join(`
`)),r&&r.length>0&&ie.trace("warnings loading server tree: "+r.join(`
`)),!!n)return n}};var oe=v("app");function vt(o){return o.treeReflectsDocument?Xe(o.tree):null}function Xe(o){return o.toJS()}function yt(o){function t(e){let{__class:r,width:n,height:s,top:i,bottom:l,left:a,right:c}=e,{children:m}=e;return m?(m=m.map(t),{__class:r,width:n,height:s,top:i,bottom:l,left:a,right:c,children:m}):e.styledText?{__class:r,width:n,height:s,top:i,bottom:l,left:a,right:c,text:e.styledText.blocks.map(u=>u.text)}:{__class:r,width:n,height:s,top:i,bottom:l,left:a,right:c}}return t(o.tree.toJS().root)}function Ct(o){let t,e=new XMLHttpRequest;e.open("GET",o.toString(),!1);try{e.send(),t=JSON.parse(e.responseText)}catch(r){oe.error(`Retrieving document \u201C${o}\u201D failed. (${r})`)}return ae(t)}function ke(o){O.isTest||o.forEach(t=>{oe.warn("[repaired]",t)})}function ae(o){let t=[];try{let e=z(o,t);return ke(t),e}catch(e){throw ke(t),oe.warn("tree failed to verify:",e),e}}var M=class extends Error{constructor(){super("cancelled"),this.name="CancelledError"}},_=class{constructor(t){this.requestIdleCallback=t;d(this,"resumePromiseResolve");d(this,"resumePromise");d(this,"backgroundMode",!1);d(this,"done",!1);d(this,"firstError");d(this,"debugStepListener")}debugResumeOneStep(){this.resume(),this.pause()}currentMode(){return this.backgroundMode?"slow":"fast"}isDone(){return!!this.firstError||this.done}isSuccess(){return!this.firstError&&this.done}isCancelled(){return!!this.firstError&&this.firstError instanceof M}isError(){return!!this.firstError&&!(this.firstError instanceof M)}getError(){return this.firstError}cancel(){this.isDone()||(this.firstError=new M)}error(t){return this.isDone()||(this.firstError=t),t}pause(){this.firstError||this.resumePromise||(this.resumePromise=new Promise(t=>{this.resumePromiseResolve=t}))}resume(){let t=this.resumePromiseResolve;t&&(this.resumePromise=void 0,this.resumePromiseResolve=void 0,t())}isPaused(){return!!this.resumePromise}fast(){this.backgroundMode=!1}slow(){this.backgroundMode=!0}async run(t){h(!this.isDone(),"task is already done");try{await t()}catch(e){throw e instanceof Error?this.error(e):this.error(new Error(String(e??"Unknown Error")))}finally{this.done=!0}}async sleep(t){if(this.debugStepListener?.(),await le(t),this.resumePromise&&await this.resumePromise,this.debugStepListener?.(),this.resumePromise&&await this.resumePromise,this.firstError)throw this.firstError}async yield(){if(this.debugStepListener?.(),this.resumePromise?await this.resumePromise:this.backgroundMode?await new Promise(t=>{this.requestIdleCallback?this.requestIdleCallback(t):typeof requestIdleCallback=="function"?requestIdleCallback(t):setTimeout(t,0)}):await A(),this.resumePromise&&await this.resumePromise,this.debugStepListener?.(),this.resumePromise&&await this.resumePromise,this.firstError)throw this.firstError}};var p=v("DocumentLoader"),Ye=10,Ie=1e3;function W(o){return o<1024*.75?`${Math.round(o)}b`:o<1024*1024*.75?`${(o/1024).toFixed(2)}kb`:`${(o/1024/1024).toFixed(2)}Mb`}function R(o){return o<200?`${o.toFixed(1)}ms`:o<20*1e3?`${(o/1e3).toFixed(3)}s`:`${Math.round(o/1e3)}s`}var Ue=class extends Re{constructor(e,r,n){super();this.treeVersion=e;this.documentURL=r;this.settings=n;d(this,"scheduler");d(this,"retryCount",0);d(this,"scopesToLoad",new Set);d(this,"prioritizedScopeIds",new Set);d(this,"currentLoadingScope");d(this,"partialParser");d(this,"canvasTreeVersion",0);d(this,"documentSize",0);d(this,"loadedFirstScope",!1);d(this,"loadingDuration",0);d(this,"parsingDuration",0);d(this,"debugPaused",!1);d(this,"loadingScopesPaused",!1);d(this,"loadAllDataPriority",0);d(this,"updatePauseResumeState",()=>{if(!this.loadedFirstScope){this.scheduler.fast(),this.scheduler.resume();return}let e=this.loadAllDataPriority>0||this.prioritizedScopeIds.size>0,r=this.loadingScopesPaused||this.debugPaused;e?this.scheduler.fast():this.scheduler.slow(),e||!r||this.scopesToLoad.size<=0?this.scheduler.resume():this.scheduler.pause()});d(this,"tree");d(this,"loadCallbacksPerScope",new Map);d(this,"addedByDiff",new Set);d(this,"removedByDiff",new Set);this.scheduler=new _(n.requestIdleCallback),p.debug("new:",this.treeVersion,this.documentURL)}pauseLoadingScopes(){this.loadingScopesPaused||(this.loadingScopesPaused=!0,p.debug("pauseLoadingScopes"),this.updatePauseResumeState())}resumeLoadingScopes(){this.loadingScopesPaused&&(this.loadingScopesPaused=!1,p.debug("resumeLoadingScopes"),this.updatePauseResumeState())}prioritizeLoadingAllData(e){let r="preload"in e&&e.preload;if(r&&U.isOn("debugEditWhileNeverLoadingRest"))return()=>{};let n=performance.now(),s=this.numberOfScopesToLoad();this.loadAllDataPriority=Math.max(1,this.loadAllDataPriority+1),p.debug("prioritizeLoadingScopes:",this.loadAllDataPriority),this.updatePauseResumeState();let i=r||"doNotTrack"in e&&e.doNotTrack,l=!1,a=i?void 0:this.afterAllDataLoaded(()=>{if(l)return;h("operationName"in e,"operationName is required");let m=performance.now()-n;Ce("fulltree_force_load",{operationName:e.operationName,durationMs:m,background:e.operationInBackground,shallowScopesCount:s})});return()=>{l||(l=!0,a?.(),this.stopPrioritizingLoadingAllData())}}stopPrioritizingLoadingAllData(){this.loadAllDataPriority-=1,p.debug("stopPrioritizingLoadingScopes:",this.loadAllDataPriority),this.updatePauseResumeState()}debugPause(){this.debugPaused||(this.debugPaused=!0,p.debug("debugPause"),this.updatePauseResumeState())}debugResume(){this.debugPaused&&(this.debugPaused=!1,p.debug("debugResume"),this.updatePauseResumeState())}isDebugPaused(){return this.debugPaused}afterAllDataLoaded(e){let r=this.scopesToLoad.size===0;if(e){if(r){let n=!1;return queueMicrotask(()=>{n||e()}),()=>{n=!0}}return this.once("loadedAllData",e),()=>{this.off("loadedAllData",e)}}return r?Promise.resolve():new Promise(n=>{this.once("loadedAllData",n)})}async start(){await this.scheduler.run(async()=>{p.debug("start"),D("parsingInit"),this.updatePauseResumeState();let e=performance.now(),r=await this.loadData();if(this.loadingDuration=performance.now()-e,await this.scheduler.yield(),!this.settings.partialParsing||typeof r=="string"&&!De(r))return this.parseFullDocumentSync(r);let n=await this.loadDocumentVersion(r);for(await this.scheduler.yield(),this.tree=await this.loadFirstTree(n),this.loadedFirstScope=!0,this.updatePauseResumeState(),await this.scheduler.yield(),D("parsingResume");this.hasNextScopeToLoad();)await this.loadNextScopeAsync(n),await this.scheduler.yield();await this.emitWrapped(()=>{h(this.tree,"tree must have been set"),this.tree.setService("loader",void 0),this.emit("loadedAllData")}),p.debug("done",W(this.documentSize),"loading:",R(this.loadingDuration),"parsing:",R(this.parsingDuration))})}async loadData(){if(this.settings.loadedData)return this.settings.loadedData;p.debug("Document in cache is not up to date. Tree version:",this.treeVersion);let e=this.settings.initData,r=e?.version===this.treeVersion,n=e?.prefetchPromise;if(e&&delete e.prefetchPromise,r&&n){p.debug("loadData: prefetch");let a=await n;if(n.then(c=>c.duration).then(c=>{D("dataLoad",c)}),await this.scheduler.yield(),a.buffer){p.debug("loadData: prefetch bytes parser");let c=await a.buffer;return await this.scheduler.yield(),a.status<200||a.status>=300?this.handleErrorAndRetry(a.status,"Error loading project data"):new Uint8Array(c)}if(a.text){let c=await a.text;return await this.scheduler.yield(),a.status<200||a.status>=300?this.handleErrorAndRetry(a.status,c):c}}p.debug("loadData: fetch");let s;this.settings.refreshAccessToken&&(s=await this.settings.refreshAccessToken({}),await this.scheduler.yield());let i=await fetch(this.documentURL,s);await this.scheduler.yield();function l(a){if(!a.body)return!1;let c=new URLSearchParams(window.location.search).has("bytes"),m=document.cookie.includes("bytes-parser=true"),u=parseInt(a.headers.get("Uncompressed-Content-Length")??"0",10)>2e8;return c&&(document.cookie="bytes-parser=true; path=/;"),c||m||u}if(D("dataLoad"),i.status<200||i.status>=300){let a=await i.text();return this.handleErrorAndRetry(i.status,a)}if(l(i)){p.debug("loadData: using streaming parser");let a=await i.arrayBuffer();return new Uint8Array(a)}else{p.debug("loadData: using text parser");let a=await i.text();return await this.scheduler.yield(),a}}async handleErrorAndRetry(e,r){let n=!1;try{n=JSON.parse(r).retry}catch{}if(n&&this.retryCount<Ye)return p.debug("onErrorStatusLoaded, retry:",this.retryCount),await this.scheduler.sleep(this.retryCount*Ie+Math.random()*Ie),this.retryCount+=1,this.loadData();throw Error(n?"Too many retries":`Fetch Error: ${e} - ${r}`)}parseFullDocumentSync(e){if(typeof e!="string")throw new Error("Full document sync parsing requires string data, not ReadableStream");let r=performance.now();this.documentSize=e.length;let n=JSON.parse(e);if(!me(n.version))throw Error("cannot read document version");if(this.canvasTreeVersion=n.version,p.debug("parseFullDocumentSync",this.canvasTreeVersion,W(this.documentSize),R(this.loadingDuration)),this.emit("loadedDocumentVersion",n.version),this.scheduler.isDone())return;let s=ae(n);this.emit("loadedFirstData",s),!this.scheduler.isDone()&&(this.emit("loadedAllData"),this.parsingDuration+=performance.now()-r,D("parsingFirstPage"),p.debug("done",W(this.documentSize),"loading:",R(this.loadingDuration),"parsing:",R(this.parsingDuration)))}hasLoadedScope(e){let r=this.scopesToLoad.has(e),n=this.currentLoadingScope?.id===e;return!r&&!n}numberOfScopesToLoad(){return this.scopesToLoad.size}prioritizeLoadingScope(e,r){let n,s;if(typeof r=="function")this.addScopeLoadCallback(e,r);else if(r&&"onLoaded"in r)this.addScopeLoadCallback(e,r.onLoaded),s=r;else{let i=he();n=i,this.addScopeLoadCallback(e,i.resolve),s=r}if(!(s?.preload&&U.isOn("debugEditWhileNeverLoadingRest")))return this.scopesToLoad.has(e)&&(this.prioritizedScopeIds.add(e),this.updatePauseResumeState(),this.addScopeLoadCallback(e,this.updatePauseResumeState)),n}nextScopeIdToLoad(){for(let r of this.prioritizedScopeIds)if(this.prioritizedScopeIds.delete(r),!!this.scopesToLoad.has(r))return this.scopesToLoad.delete(r),this.scheduler.fast(),r;let e=this.loadAllDataPriority>0;this.settings.loadInBackground&&!e?this.scheduler.slow():this.scheduler.fast();for(let r of this.scopesToLoad)return this.scopesToLoad.delete(r),r;throw Error("No next scope to load")}async loadDocumentVersion(e){let r=performance.now(),n=await q.createPartialParser(e,this.settings);return typeof e=="string"?this.documentSize=e.length:this.documentSize=0,this.canvasTreeVersion=n.canvasTreeVersion,this.parsingDuration+=performance.now()-r,p.debug("loadDocumentVersion",this.canvasTreeVersion,typeof e=="string"?W(this.documentSize):"stream",R(this.loadingDuration)),await this.emitWrapped(()=>{if(this.scheduler.isDone())return;let s=performance.now();this.emit("loadedDocumentVersion",this.canvasTreeVersion),this.parsingDuration+=performance.now()-s}),this.partialParser=n,n}async loadFirstTree(e){let r=performance.now(),n=e.readFirstPage();this.scopesToLoad=e.getScopesToLoad();for(let s of this.scopesToLoad){let i=n.get(s);i&&(i.cache.isShallowLoad=!0)}return this.parsingDuration+=performance.now()-r,p.debug("loadFirstTree",R(this.parsingDuration)),await this.emitWrapped(()=>{if(this.scheduler.isDone())return;let s=performance.now();n.setService("loader",this),n.chunkingHints=e.chunkingHints,this.emit("loadedFirstData",n),D("parsingFirstPage"),this.parsingDuration+=performance.now()-s}),n}hasNextScopeToLoad(){return this.scopesToLoad.size>0}async loadNextScopeAsync(e){h(!this.currentLoadingScope,"already have a currently loading scope");let r=this.nextScopeIdToLoad();this.currentLoadingScope=new H(r,e);let n=await this.currentLoadingScope.run(this.scheduler);p.debug("loadScopeAsync:",r,R(n.duration),"scheduler mode:",this.scheduler.currentMode()),n.hasNode()&&await this.emitWrapped(()=>{if(this.scheduler.isDone())return;let s=performance.now(),i=n.take();this.currentLoadingScope=void 0,i&&(this.emit("loadedScope",i),this.parsingDuration+=n.duration+performance.now()-s,this.signalScopeLoadCallbacks(i.id))})}loadScope(e){if(h(this.partialParser,"loadScope before the parser is available"),this.currentLoadingScope?.id===e){let n=this.currentLoadingScope.force();return this.parsingDuration+=n.duration,this.currentLoadingScope=void 0,n.take()}if(this.prioritizedScopeIds.delete(e),!this.scopesToLoad.has(e))return;this.scopesToLoad.delete(e);let r=new H(e,this.partialParser).force();return this.parsingDuration+=r.duration,p.debug("loadScope:",e,R(r.duration)),this.signalScopeLoadCallbacks(e),r.take()}addScopeLoadCallback(e,r){if(!r)return;if(this.hasLoadedScope(e)){setTimeout(r);return}let n=this.loadCallbacksPerScope.get(e)??[];n.push(r),this.loadCallbacksPerScope.set(e,n)}signalScopeLoadCallbacks(e){setTimeout(()=>{let r=this.loadCallbacksPerScope.get(e);if(r){for(let n of r)n();this.loadCallbacksPerScope.delete(e)}})}async emitWrapped(e){this.settings.asyncEventWrapper?(await this.scheduler.yield(),await this.settings.asyncEventWrapper(e)):(await this.scheduler.yield(),e())}resetTreeForRecovery(e){e.setService("loader",this);for(let r of this.scopesToLoad){let n=e.get(r);n&&(n.cache.isShallowLoad=!0)}this.tree=e}async nodeIdsToLoad(){let e=performance.now(),r=new Set;if(!this.partialParser)return r;let n=performance.now();for(let s of this.scopesToLoad){performance.now()-n>50&&(await A(),n=performance.now());let i=this.partialParser.getParsedPageById(s);Me(r,i)}for(let s of this.addedByDiff)r.add(s);for(let s of this.removedByDiff)r.delete(s);return p.debug("nodeIdsToLoad",r.size,R(performance.now()-e)),r}addNodeChanges(e){for(let r of e){let n=r.id;r.added?(this.addedByDiff.add(n),this.removedByDiff.delete(n)):r.removed&&(this.addedByDiff.delete(n),this.removedByDiff.add(n))}}};function Me(o,t){if(t&&(o.add(t.id),!!t.children))for(let e of t.children)Me(o,e)}var j=class{constructor(t,e){this.node=t;this.duration=e}hasNode(){return!!this.node}take(){let t=this.node;return this.node=void 0,t}},H=class{constructor(t,e){this.id=t;this.parser=e;d(this,"data");d(this,"loadedScope")}async run(t){if(this.loadedScope)return this.loadedScope;let e=performance.now();this.data=this.parser.getParsedPageById(this.id);let r=performance.now()-e;if(await t.yield(),this.loadedScope)return this.loadedScope;let n=performance.now(),s=this.parser.buildPage(this.data);return s&&(s.cache.isShallowLoad=!1),this.loadedScope=new j(s,r+performance.now()-n),this.loadedScope}force(){if(this.loadedScope)return this.loadedScope;let t=performance.now();this.data||(this.data=this.parser.getParsedPageById(this.id));let e=this.parser.buildPage(this.data);return e&&(e.cache.isShallowLoad=!1),this.loadedScope=new j(e,performance.now()-t),this.loadedScope}};var x=v("tree:timeline"),de=class{constructor(t){this.nodeChangesBuffers=t;d(this,"changes",new Map);this.nodeChangesBuffers.add(this)}trackChange(t,e){let r=this.changes.get(t);if(r){e&&r.push(e);return}this.changes.set(t,e?[e]:[])}read(){let t=this.changes;return this.changes=new Map,t}clear(){this.changes=new Map}dispose(){this.nodeChangesBuffers.delete(this)}},G=class{constructor(t,e,r=[],n=!1,s=!1){this.tree=t;this.changes=e;this.editReasons=r;this.wasRebase=n;this.wasCrdtRemote=s;d(this,"wasScopeInsert",!1);d(this,"version",0)}toDebugData(){return{version:this.version,changes:this.changes,editReasons:this.editReasons,wasScopeInsert:this.wasScopeInsert,wasRebase:this.wasRebase,wasCrdtRemote:this.wasCrdtRemote}}},J=class{constructor(){d(this,"idToChanges",new Map)}getChanges(){return Array.from(this.idToChanges.values())}addChanges(t){if(t)for(let e of t){let r=this.idToChanges.get(e.id);r||(r={id:e.id,to:{}},this.idToChanges.set(e.id,r)),te(r,e)}}},$=class{constructor(t,e){d(this,"tree");d(this,"entries");d(this,"latestReversibleNodeChanges",null);d(this,"enableAddRemoveOptimizations",!0);d(this,"trimmed",0);d(this,"isPartialLoading",!1);d(this,"remoteTreeIndex",0);d(this,"inErrorRecovery",!1);d(this,"nodeChangesBuffers",new Set);d(this,"legacyMode",!1);d(this,"remoteTreeVersion",0);d(this,"recentEditReasons",[]);d(this,"flagsForNextCommit");d(this,"extraChangesForNextCommit");d(this,"resetTime",0);d(this,"epoch",0);this.reset(t,e)}get length(){return this.entries.length+this.trimmed}get localTreeIndex(){return this.length-1}setFlagsForNextCommit(t){this.flagsForNextCommit=t}setExtraChangesForNextCommit(t){this.extraChangesForNextCommit=t}recordEditReasons(t){t&&this.recentEditReasons.push(t)}trackChange(t,e=null){for(let r of this.nodeChangesBuffers)r.trackChange(t,e)}getTreeForVersion(t){if(!this.isPartialLoading)return Te(this.entries,e=>e.version===t)?.tree}addEntry(t,e,r=[],n=!1,s=!1){let i=new G(t,e,r,n,s);return this.entries.push(i),this.tree=t,i}getLastEntry(){let t=this.entries[this.entries.length-1];return h(t,"Timeline has no entries"),t}getEntry(t){return this.entries[t]}reset(t,e){if(this.resetTime=performance.now(),this.inErrorRecovery&&t===this.tree){x.debug("reset for error recovery..."),this.inErrorRecovery=!1,this.invalidateAllCursors(),this.clearNodeChangesReader();return}x.debug("reset with tree:",t.root.id,"size:",t.size()),this.entries=[],this.addEntry(t,e?.initialChanges??[],["load"]),this.recentEditReasons=[],this.flagsForNextCommit=void 0,this.extraChangesForNextCommit=void 0,this.latestReversibleNodeChanges=null,this.trimmed=0,this.remoteTreeIndex=0,this.isPartialLoading=!!e?.isLoading,this.invalidateAllCursors(),this.clearNodeChangesReader()}invalidateAllCursors(){this.epoch+=1}openNodeChangesReader(){return new de(this.nodeChangesBuffers)}clearNodeChangesReader(){for(let t of this.nodeChangesBuffers)t.clear()}applyFlagsToChange(t){t&&this.flagsForNextCommit&&(this.flagsForNextCommit.ignoreInUndo&&(t.ignoreInUndo=!0),this.flagsForNextCommit.ignoreInCodeGeneration&&(t.ignoreInCodeGeneration=!0))}commitLocalTree(){let t=this.getLastEntry();h(this.tree===t.tree,"tree out of sync");let e={};this.tree=this.tree.commit((n,s)=>{if(!n&&!s)return;let i=B(n,s);if(this.applyFlagsToChange(i),this.trackChange(n?.id??s.id,i),i){if(i.to.parentid&&i.to.parentid!==i.from?.parentid){let a=this.tree.getScopeNodeAtStartFor(n),c=this.tree.getScopeNodeFor(s);a&&a?.id!==c?.id&&(i.previousScope=a.id)}e[i.id]=i}let l=[];be(l,n,s);for(let a of l)this.applyFlagsToChange(a),this.trackChange(a.id,a),e[a.id]=a}),this.latestReversibleNodeChanges=Object.values(e);let r=this.latestReversibleNodeChanges;if(this.extraChangesForNextCommit){r=[...r];for(let n of this.extraChangesForNextCommit)this.applyFlagsToChange(n),this.trackChange(n.id,n),r.push(n)}return this.flagsForNextCommit=void 0,this.extraChangesForNextCommit=void 0,x.debug("commit local tree:",r.length,this.recentEditReasons),r.length>0?(h(t.tree!==this.tree,"must be a new tree"),t.tree.releaseMemory(),this.entries.push(new G(this.tree,r,this.recentEditReasons))):this.tree!==t.tree&&(t.tree.releaseMemory(),t.tree=this.tree),this.recentEditReasons=[],h(this.tree===this.getLastEntry().tree),this.tree}getLatestChangesForUndo(){return this.latestReversibleNodeChanges}getChangeTrackingCursor(){let t=this.remoteTreeIndex,e=this.localTreeIndex;return{remoteTree:t,localTree:e,timeline:this,tree:this.tree,epoch:this.epoch}}invalidatedByLoadCompletedDocument(t){return!(!t||this.trimmed>0||t.timeline!==this||t.epoch+1!==this.epoch||t.remoteTree+1!==this.remoteTreeIndex)}fetchForwardChanges(t){if(!t||t.epoch!==this.epoch||t.tree.lineage!==this.tree.lineage||t.tree.root.id!==this.tree.root.id||t.timeline!==this||t.localTree>0&&t.localTree<=this.trimmed||t.remoteTree>0&&t.remoteTree<=this.trimmed||this.remoteTreeIndex>0&&this.trimmed>0&&t.remoteTree===0)return;let e=t.localTree;if(this.remoteTreeIndex>0)for(e=t.remoteTree-1;e<t.localTree&&!this.entries[e+1-this.trimmed]?.wasRebase;)e+=1;h(e-this.trimmed>=0,"buffer cut too close to remoteTree"),h(e<=t.localTree,"startIndex incorrectly calculated");let r=this.localTreeIndex;h(e<=r,"bad change tracking cursor");let n=t.tree;return t.remoteTree=this.remoteTreeIndex,t.localTree=r,t.tree=this.tree,this.computeForwardChanges(e,r,n)}computeForwardChanges(t,e,r){if(t>=e)return[];let n={};for(let i=t+1;i<=e;i++){let l=this.entries[i-this.trimmed];if(!l.wasCrdtRemote)for(let a of l.changes){let c=a.id,m=n[c];m||(m=n[c]={id:c,to:{}});let u=m.added;te(m,a),!r&&u&&m.removed&&this.enableAddRemoveOptimizations&&delete n[c]}}let s=r??this.entries[t-this.trimmed]?.tree;if(!s)throw new Error(`${t} - ${this.trimmed}`);return Object.values(n).filter(i=>{if(i.removed)return i.to={},!0;let l=s.getNodeAtStart(i.id);if(l&&this.enableAddRemoveOptimizations)for(let[u,P]of Object.entries(i.to))ue(l[u],P)&&delete i.to[u];if(i.added||Object.keys(i.to).length>0)return!0;let a=i.toChildren;if(!a)return!1;if(!l)return!0;s.beginAllowPartialScopeAccess();let c=l.children;if(s.endAllowPartialScopeAccess(),!c||!this.enableAddRemoveOptimizations)return!0;let m=c.length;if(m!==a.length)return!0;for(let u=0;u<m;u++)if(c[u].id!==a[u])return!0;return!1})}getEditReasons(t,e){let r=[],n="";for(let s=t+1;s<=e;s++){let i=this.entries[s-this.trimmed].editReasons;for(let l of i)l&&n!==l&&(n=l,r.push(l))}return r.join(" ")}getChangesBetweenEntries(t,e){h(t<e,"inconsistency in getting local changes to send");let r=this.computeForwardChanges(t,e),n=this.getEditReasons(t,e);return{count:e-t,changes:r,reasons:n}}debugOverwriteCurrentTree(t){x.debug("recover with tree:",t.root.id),this.tree=t,this.getLastEntry().tree=t}resetTreesForRecovery(t,e){x.info("reset trees for recovery, remote:",this.remoteTreeIndex,"local:",this.localTreeIndex,"changes already sent:",e);let r=this.entries[t]?.tree;h(r,"unable to get remote tree");let n=r.getService("loader"),s=r.lineage.editHooks,i=[];try{r=z(JSON.parse(JSON.stringify(r.toJS())),i)}catch(a){if(a instanceof RangeError&&a.message.includes("Invalid string length"))x.warn("[recovery] Tree too large for JSON serialization, using original tree",{error:a.message,treeSize:r.size()}),i.push("Recovery skipped: tree too large for serialization");else throw a}n&&(n.resetTreeForRecovery(r),h(r.getService("loader")===n,"tree must have the same loader")),s&&(r.lineage.editHooks=s),i.length>0&&x.warn("[recovery] encountered errors while reloading the tree:",i),this.entries[t].tree=r,this.entries.length=t+e+1;let l=r;for(let a=t+1;a<this.entries.length;a++){let c=this.entries[a];C(r,c.changes),r=r.commitDiffs(),c.tree=r,r!==l&&(l.releaseMemory(),l=r)}return this.inErrorRecovery=!0,this.tree=r,r}saveTimelineDataForRecovery(){if(window.localStorage)try{let t=`debugTimelineAtRecovery-${Math.floor(Math.random()*100)}`,e={date:new Date().toString(),entries:this.entries.map(r=>r.toDebugData())};window.localStorage.setItem(t,JSON.stringify(e))}catch(t){x.warn("failed to store timeline in localStorage:",t)}}};var Fe=class{constructor(){d(this,"undoBuffer",[]);d(this,"redoBuffer",[]);d(this,"undoGroup",[]);d(this,"scheduledEndUndoGroup")}canUndo(){return this.undoBuffer.length>0}peekUndo(){return this.undoBuffer.at(-1)}undo(t,e){let r=this.undoBuffer.pop();if(I(r))return;se(t,r.changes),this.redoBuffer.push({...r,...e});let n=this.undoBuffer.length;return this.undoGroup.forEach((s,i)=>{this.undoGroup[i]=Math.min(s,n)}),r}canRedo(){return this.redoBuffer.length>0}peekRedo(){return this.redoBuffer.at(-1)}redo(t,e){let r=this.redoBuffer.pop();if(!I(r))return C(t,r.changes),this.undoBuffer.push({...r,...e}),r}beginUndoGroup(){this.undoGroup.push(this.undoBuffer.length)}discardUndoGroup(t){let e=this.undoGroup.pop();if(I(e)||e>=this.undoBuffer.length)return;let r=this.undoBuffer.splice(e),n=re(r);return se(t,n),r[0]}scheduleEndUndoGroup(){let t=this.undoGroup.pop();I(t)||t>=this.undoBuffer.length||(this.scheduledEndUndoGroup=t)}processScheduledEndUndoGroup(t){let e=this.scheduledEndUndoGroup;if(this.scheduledEndUndoGroup=void 0,I(e)||e>=this.undoBuffer.length)return;let r=this.undoBuffer.splice(e),n=re(r);this.undoBuffer.push({changes:n,...t})}clearUndoStack(){this.undoBuffer.length=0,this.redoBuffer.length=0}addUndoEntry(t){this.undoBuffer.push(t),this.redoBuffer.length=0}getUndoBufferSize(){return this.undoBuffer.length}};var f=Ge(Je());var Ke=0,X=class{constructor(){d(this,"id",++Ke);d(this,"currentRtt",NaN);d(this,"rtts",[]);d(this,"rttIndex",0);d(this,"pending",Array.from(Array(128),()=>({type:"",time:0})));d(this,"start",0);d(this,"end",0);d(this,"overflow",0);d(this,"lastSendTime",0);d(this,"bytesSent",0);d(this,"bytesReceived",0)}read(){let{bytesSent:t,bytesReceived:e,id:r}=this;return this.bytesSent=0,this.bytesReceived=0,[t,e,this.rtt(),r]}computeRtt(){let t=this.rtts.length;if(t===0){this.currentRtt=NaN;return}let e=0;for(let r of this.rtts)e+=r;this.currentRtt=e/t}lastSend(){return this.lastSendTime}rtt(){return Number.isNaN(this.currentRtt)&&this.computeRtt(),Math.max(this.currentRtt||0,this.pendingRtt())}pendingRtt(){return this.start===this.end?0:performance.now()-this.pending[this.start].time}pendingCount(t){if(!t)return this.start>this.end?128-this.start+this.end:this.end-this.start;let e=0;for(let r=this.start;r!==this.end;r=r+1&127)this.pending[r].type===t&&e++;return e}sent(t,e){this.bytesSent+=e.length,this.end===(this.start===0?127:this.start-1)&&(this.start=this.start+1&127,this.overflow++);let r=this.pending[this.end];r.type=t,r.time=performance.now(),this.end=this.end+1&127,this.lastSendTime=r.time}received(t){this.bytesReceived+=t.length}acked(){if(this.start===this.end){console.warn("Called SocketStats.acked() with empty buffer");return}if(this.overflow>0){this.overflow--;return}let t=this.pending[this.start],e=performance.now()-t.time;this.rtts.length<32?this.rtts.push(e):(this.rtts[this.rttIndex]=e,this.rttIndex=this.rttIndex+1&31),this.start=this.start+1&127,this.currentRtt=NaN}};var L=v("remote:socket"),Qe=25;function Ze(o){switch(o){case"AccessDenied":case"ClientNeedsUpdate":case"ClientTooNew":case"DocumentNotFound":case"UnsupportedSchema":case"UnknownPermanentError":case"ClientSidePermanentError":return!1;case"ReconnectToNewServer":case"UnknownRecoverableError":case"ClientSideRecoverableError":return!0;default:return ce(o)}}function tr({url:o,documentConnection:t,tunnel:e=null}){let r=(0,f.useRef)(null),n=(0,f.useRef)(!0),s=(0,f.useRef)({onConnect:new Set,onDisconnect:new Set,onMessage:new Set}),i=(0,f.useRef)(o),l=(0,f.useRef)(!0),a=(0,f.useRef)(void 0);function c(){a.current!==void 0&&(window.clearTimeout(a.current),a.current=void 0)}let m=(0,f.useCallback)(()=>{l.current=!1;let g=r.current;g&&g.ws.readyState<WebSocket.CLOSING&&(g.clientClosed=!0,g.ws.close())},[]),u=(0,f.useCallback)(()=>{if(c(),!l.current||r.current)return;function g(T){a.current===void 0&&(a.current=window.setTimeout(()=>{a.current=void 0,navigator.onLine&&!document.hidden&&u()},T))}let y=new URL(i.current);if(y.searchParams.set("v",Qe.toString()),y.searchParams.set("tunnel",e||""),Ee()&&y.searchParams.set("mode","crdt"),t.treeSchema<=0)return;y.searchParams.set("treeSchema",t.treeSchema.toString()),y.searchParams.set("treeVersion",t.treeVersion.toString()),L.debug("connecting to",y.href);let je=performance.now(),k=new WebSocket(y.href),E=new X,K={ws:k,stats:E,clientClosed:!1};t.setSocketStats(E);let F=0;k.addEventListener("open",()=>{L.debug("open"),F=window.setInterval(()=>{if(performance.now()-E.lastSend()<1e3||E.pendingCount("ping")>1||k.readyState!==WebSocket.OPEN)return;let T="ping {}";k.send(T),E.sent("ping",T)},1e3);for(let T of s.current.onConnect)try{T(n.current)}catch(b){L.warn("Error in onConnect handler:",b)}n.current=!1}),k.addEventListener("close",T=>{let b=tt(T);if(L.debug("close:",b,"clientClosed:",K.clientClosed,T),F!==0&&(clearInterval(F),F=0),r.current===K){Ze(b)||(l.current=!1);for(let w of s.current.onDisconnect)try{w(b)}catch(Q){L.warn("Error in onDisconnect handler:",Q)}if(r.current=null,l.current){let w=1e3;b==="ReconnectToNewServer"?w=50:performance.now()-je<5e3&&(w=5e3),g(w)}}}),k.addEventListener("message",T=>{try{let b=T.data;E.received(b);let w=rt(b);if(w.type==="ack"){E.acked();return}else w.type==="redirect"&&(i.current=w.value.url);for(let Q of s.current.onMessage)try{Q(w)}catch(He){L.warn("Error in onMessage handler:",He)}}catch(b){L.warn("Error receiving:",b)}}),r.current=K},[t]);(0,f.useEffect)(()=>{u()},[u]);let P=(0,f.useCallback)(({online:g,visible:y})=>{g&&y?u():c()},[u]);return et(P),(0,f.useMemo)(()=>({getSocketStats(){return r.current?.stats},connect(){l.current=!0,u()},disconnect(){m()},onConnect(g){return s.current.onConnect.add(g),()=>{s.current.onConnect.delete(g)}},onDisconnect(g){return s.current.onDisconnect.add(g),()=>{s.current.onDisconnect.delete(g)}},onMessage(g){return s.current.onMessage.add(g),()=>{s.current.onMessage.delete(g)}},send(g){if(!r.current||r.current.ws.readyState!==1){g.type!=="state"&&L.warn("Dropping",g.type,"message.");return}try{let y=`${g.type} ${JSON.stringify(g.value)}`;r.current.ws.send(y),r.current.stats.sent(g.type,y)}catch(y){L.warn("Error sending",g.type,"message:",y)}}}),[u,m])}function et(o){(0,f.useEffect)(()=>{document.addEventListener("visibilitychange",t),window.addEventListener("online",t),window.addEventListener("offline",t);function t(){o({online:navigator.onLine,visible:!document.hidden})}return()=>{document.removeEventListener("visibilitychange",t),window.removeEventListener("online",t),window.removeEventListener("offline",t)}},[o])}function tt(o){switch(o.reason){case"ERR_RECONNECT_TO_NEW_SERVER":return"ReconnectToNewServer";case"ERR_ACCESS_DENIED":return"AccessDenied";case"ERR_CLIENT_NEEDS_UPDATE":return"ClientNeedsUpdate";case"ERR_DOCUMENT_NOT_FOUND":return"DocumentNotFound";case"ERR_UNSUPPORTED_SCHEMA_VERSION":return"UnsupportedSchema";case"ERR_INVALID_OPERATION":return"ClientSidePermanentError";case"ERR_UNKNOWN":return"UnknownPermanentError"}return o.code===1011?"ClientNeedsUpdate":"UnknownRecoverableError"}function rt(o){let t=o.indexOf(" "),e=o.indexOf(" ",t+1);h(t>=0&&e>=0,"Invalid data");let r=o.substring(0,t),n=o.substring(t+1,e),s=o.substring(e+1),i=JSON.parse(s);return{id:r,type:n,value:i}}function nr(o){let{appEnvironment:t,session:e,seq:r,count:n,reasons:s,changes:i}=o;return{appEnvironment:t,session:e,seq:r,changes:i,count:n,reasons:s}}function Ae(o,t){return{...o,next:t}}function Oe(o){return typeof o=="object"&&o!==null&&"next"in o}function Ve(o){return Oe(o)&&"session"in o}function Be(o){return Oe(o)&&"changes"in o&&Array.isArray(o.changes)}function ze(o){if(!o.children)return;let t=new Map;for(let e of o.children)ge(e)&&t.set(e.id,{master:e,replicas:new Map});for(let e of o.children){if(!pe(e))continue;let r=t.get(e.replicaInfo.master);r&&r.replicas.set(e.id,e)}for(let{master:e,replicas:r}of t.values())nt(e,r)}function nt(o,t){for(let e of t.values()){let r=e.replicaInfo;h(r.master===o.id,"Replica must match master");let n=r.overrides;if(r.inheritsFrom){let u=t.get(r.inheritsFrom);u&&(n=ve(n,u.replicaInfo.overrides))}let s=n[o.id],i=e.duplicatedFrom;ee.copyToNode(e,o,s),e.duplicatedFrom=i;let l=!1;fe(e)&&(l=!0,ye(e,n,o),Z(o,e));let a=e.id,c=o.children;if(!c)return;let m=new Array(c.length);for(let u=0,P=c.length;u<P;u++)m[u]=qe(a,n,c[u],a,l);e.children=m}}function qe(o,t,e,r,n){let s=V({__class:e.__class,id:o+e.id,parentid:r});h(s,"Failed to create replica node");let i=t[e.id];if(ee.copyToNode(s,e,i),s.duplicatedFrom=null,n&&Z(e,s),e.children){let l=e.children,a=new Array(l.length);for(let c=0,m=l.length;c<m;c++)a[c]=qe(o,t,l[c],s.id,n);s.children=a}return s}var N=v("remote:sync"),_e=2**52,Y=class{constructor(t,e=0,r,n){d(this,"rollingDiff",null);d(this,"session",Math.floor(Math.random()*_e));d(this,"seq",0);d(this,"treeVersion",0);d(this,"updatesSeen",0);d(this,"init",0);d(this,"expectingInitialUpdates",0);d(this,"timeline");d(this,"localUpdatesInFlight",[]);d(this,"localUpdatesAtInit",[]);d(this,"hasError",!1);d(this,"waitingForTree",!1);r?this.timeline=r:this.timeline=new $(t),this.setTree(t,e,n)}get waitingForInitialUpdates(){return this.expectingInitialUpdates>this.updatesSeen}get isLoading(){return this.waitingForTree||this.waitingForInitialUpdates}get isReady(){return!(this.hasError||this.waitingForTree||this.waitingForInitialUpdates)}get tree(){return this.timeline.tree}error(t){return this.hasError=!0,Error(t)}verify(t,e){let r=this.timeline.getTreeForVersion(t);if(!r)return N.info("verify: unable to find tree with version",t),!0;let n=r.computeTreeHash();if(n!==e){if(N.warn("verify: failed",n,"!==",e),e===0)return!0;N.reportError("Tree verification failed",{localHash:n,serverHash:e,treeVersion:t,treeSize:r.size()})}else N.debug("verify: passed; hash:",e);return n===e}setTree(t,e,r){N.info("setTree",e),this.timeline.reset(t,r),this.setRemoteTreeVersion(e),!!r?.isLoading&&U.isOn("rollingDiff")&&(this.rollingDiff=new J,this.rollingDiff.addChanges(r?.initialChanges)),this.treeVersion=e,this.waitingForTree=!1,this.hasError=!1,this.localUpdatesInFlight=[]}resetSession(){this.treeVersion=0,this.session=Math.floor(Math.random()*_e),this.localUpdatesInFlight=[],this.localUpdatesAtInit=[]}debugResetSessionAndTree(t){this.resetSession(),this.setTree(t,0)}handleInit(t,e){return this.init+=1,this.init===1&&D("wsTreeInitMessages"),N.info("init",this.init,{treeVersion:t,initialUpdates:e,localTreeVersion:this.treeVersion}),N.debug("init updates:",{seen:this.updatesSeen,inFlight:this.localUpdatesInFlight.length,previous:this.localUpdatesAtInit.length}),this.hasError=!1,this.expectingInitialUpdates=e,this.updatesSeen=0,this.localUpdatesAtInit=this.localUpdatesInFlight.slice(),this.treeVersion!==t||this.waitingForTree?(this.waitingForTree=!0,!0):!1}trimForShallowLoading(){let t=this.timeline,e=this.getRemoteIndex()-3;e<=0||(t.trimmed+=e,N.debug("trim",e,"new offset:",t.trimmed,"entries.length:",t.entries.length,"after load"),t.entries.splice(0,e),h(this.timeline.remoteTreeIndex===0||this.getRemoteIndex()>=0,"must have some buffer before remoteTreeIndex"))}loadedAllScopes(){let t=this.timeline;N.info("done loading, took:",Math.round((performance.now()-t.resetTime)/100)/10,"seconds"),h(t.isPartialLoading,"Must be in loading mode"),t.isPartialLoading=!1,this.rollingDiff=null;let e=this.getRemoteEntry();e&&(e.version=t.remoteTreeVersion,this.trimForShallowLoading())}loadOneScope(t,e){let r=this.timeline;N.debug("loadOneScope:",t.id),h(r.isPartialLoading,"Must be loading"),h(!t.cache.isShallowLoad,"Scope must not be shallow");let n=this.getRemoteEntry();h(n,"remote tree is missing");let s=r.tree.isViewOnly;n.tree.editClosed=!1,n.tree.isViewOnly=!1,n.tree.inEditor=!1,n.tree.makeLatest();let i=new Set,l=n.tree.root.children.findIndex(c=>c.id===t.id);if(t.__class==="WebPageNode"||t.__class==="SmartComponentNode"){ze(t),n.tree=n.tree.commitWithLoadedScope(t);for(let c of t.walk())r.trackChange(c.id),i.add(c.id)}else n.tree.remove(t.id),n.tree.insertNode(t,n.tree.root.id,l);if(this.rollingDiff){let c=this.rollingDiff.getChanges();i.size>0?ne(c,i)&&C(n.tree,c):C(n.tree,c)}else{let c=0,m=i.size>0,u=this.getRemoteIndex();for(let P of r.entries){if(c>u)break;c++,!P.wasScopeInsert&&(m&&!ne(P.changes,i)||(m=!1,C(n.tree,P.changes)))}}l===-1?h(!n.tree.get(t.id),"Scope must have been deleted by remote diffs"):n.tree.loadReplicasAndCodeComponents(t);let a=n.tree.commit((c,m)=>{let u=c?.id??m?.id;u&&r.trackChange(u)});return n.tree.inEditor=!0,a.inEditor=!0,this.incrementRemoteTreeIndex(),e||(r.latestReversibleNodeChanges=null),this.addTreeToTimeline(a),r.legacyMode&&r.invalidateAllCursors(),a.isViewOnly=s,this.rollingDiff&&this.trimForShallowLoading(),r.tree}getRemoteEntry(){return this.timeline.getEntry(this.getRemoteIndex())}setRemoteTreeVersion(t){if(this.timeline.remoteTreeVersion=t,this.timeline.isPartialLoading)return;let e=this.getRemoteEntry();h(e,"remote tree is missing"),e.version=t}};var S=v("remote:sync"),We=class extends Y{constructor(){super(...arguments);d(this,"localChangesSentToRemote",0)}setTree(e,r,n){super.setTree(e,r,n),this.localChangesSentToRemote=0}handleRemoteUpdate(e){if(this.hasError||this.waitingForTree)return;h(typeof e.next=="number","must be a valid tree update");let r=e.next;if(S.trace("this:",this.session,this.seq,"at:",this.treeVersion,"update:",e),r!==this.treeVersion+1){if(r<=this.treeVersion){S.debug("ignoring old update:",r," <= ",this.treeVersion);return}throw this.error("missing update: "+this.treeVersion+" + 1 != "+r)}if(this.updatesSeen+=1,this.treeVersion=r,Ve(e)&&e.session===this.session){let n=this.localUpdatesInFlight[0];if(n?.seq===e.seq)this.localUpdatesInFlight.shift(),this.confirmLocalChangesByRemote(n.count,r),n.confirmed=!0;else{let s=this.localUpdatesAtInit.find(i=>i.seq===e.seq);if(s)this.insertRemoteChanges(s.changes,r),s.confirmed=!0;else{let i=this.localUpdatesInFlight.findIndex(a=>a.seq===e.seq),l=i===-1?"unknown local update: "+e.seq+" != "+n?.seq:"missing local update: "+e.seq+" != "+n?.seq+", is index: "+i;throw this.error(l)}}}else Be(e)?e.changes.length>0&&this.insertRemoteChanges(e.changes,r):S.reportErrorOncePerMinute(new Error("Unknown remote update"),{update:e})}confirmLocalChangesByRemote(e,r=0){let n=this.timeline;if(h(e>=1,"cannot confirm less than one change"),h(this.localChangesSentToRemote>=e,"cannot confirm local changes that have not been sent"),h(n.remoteTreeIndex<n.localTreeIndex,"must have unconfirmed local changes"),this.rollingDiff)for(let s=1;s<=e;s++)this.rollingDiff.addChanges(n.getEntry(n.remoteTreeIndex+s)?.changes);return this.localChangesSentToRemote-=e,n.remoteTreeIndex+=e,this.setRemoteTreeVersion(r),n.tree}insertRemoteChanges(e,r=0){let n=this.timeline;S.debug("insertRemoteChanges:",e.length),h(n.tree===n.getLastEntry().tree,"tree out of sync"),h(n.remoteTreeIndex<=n.localTreeIndex,"remote tree too far ahead"),this.rollingDiff&&this.rollingDiff.addChanges(e);let s=this.getRemoteEntry();h(s,"remote tree is missing");let i=n.tree.isViewOnly;s.tree.editClosed=!1,s.tree.isViewOnly=!1,s.tree.makeLatest(),s.tree.beginAllowPartialScopeAccess(),C(s.tree,e);let l=s.tree.commitDiffs();for(let c of e)n.trackChange(c.id,c);for(let c of s.tree.getNodesChangedByCommit())n.trackChange(c.id);n.remoteTreeIndex+=1,n.latestReversibleNodeChanges=null;let a=n.entries.length-this.getRemoteIndex();return h(a>=0,"computed rebase is off"),a===0?this.addRemoteTreeWithChanges(l,e):this.rebaseRemoteTreeWithChanges(l,e,a),this.trim(),this.setRemoteTreeVersion(r),s.tree.endAllowPartialScopeAccess(),l.isViewOnly=i,n.tree}addRemoteTreeWithChanges(e,r){S.trace("addRemoteTreeWithChanges:",r.length);let n=this.timeline.getLastEntry();return h(e.lineage===n.tree.lineage,"Trees must belong to the same line."),h(!e.hasUncommittedChanges(),"Tree cannot have uncommitted changes."),n.tree!==e&&n.tree.releaseMemory(),this.timeline.addEntry(e,r)}rebaseRemoteTreeWithChanges(e,r,n){let s=this.timeline;S.debug("rebaseRemoteTreeWithChanges:",n,"changes:",r.length),h(e.lineage===s.getLastEntry().tree.lineage,"Trees must belong to the same line."),h(!e.hasUncommittedChanges(),"Tree cannot have uncommitted changes."),h(s.entries.length>=n,"rebase",n,"> commits",s.entries.length);let i=s.entries.splice(s.entries.length-n,n);h(i.length===n,"must have",n,"entries to process");let l=s.addEntry(e,r,[],!0),a=e;for(let c=0;c<n;c++){let m=i[c];C(e,m.changes),e=e.commitDiffs();for(let u of m.changes)s.trackChange(u.id,u);for(let u of a.getNodesChangedByCommit())s.trackChange(u.id);s.addEntry(e,m.changes,m.editReasons,m.wasRebase),e!==a&&(a.releaseMemory(),a=e)}return s.tree=e,l}addTreeToTimeline(e){let n=this.timeline.entries.length-this.getRemoteIndex();h(n>=0,"computed rebase is off");let s;n===0?s=this.addRemoteTreeWithChanges(e,[]):s=this.rebaseRemoteTreeWithChanges(e,[],n),s.wasScopeInsert=!0}loadCompleteTree(e,r=0){let n=this.timeline;S.debug("load complete tree:",n.tree.sizeAtStart(),"->",e.size(),"entries:",n.entries.length),h(n.trimmed===0,"cannot load complete tree while having local changes"),h(!e.hasUncommittedChanges(),"tree should be clean"),n.entries.forEach((a,c)=>{c>n.remoteTreeIndex||C(e,a.changes)}),e.hasUncommittedChanges()&&(e=e.commitDiffs());let s=[],i=n.tree;if(i.sizeAtStart()*2>e.size()){let a={};for(let c of e.root.walk()){let m=i.getNodeAtStart(c.id)||void 0,u=B(m,c);u&&(a[u.id]=u),n.trackChange(c.id,u)}s=Object.values(a),S.debug("load complete tree, diff:",s.length)}else n.invalidateAllCursors(),S.debug("load complete tree, resending:",n.tree.size());n.remoteTreeIndex+=1,n.latestReversibleNodeChanges=null;let l=n.entries.length-n.remoteTreeIndex;return h(l>=0,"computed rebase is off"),e.lineage!==n.tree.lineage?(n.reset(e),this.setRemoteTreeVersion(r),n.tree):(l===0?this.addRemoteTreeWithChanges(e,s):this.rebaseRemoteTreeWithChanges(e,s,l),this.setRemoteTreeVersion(r),this.trim(),n.tree.forEachNode(a=>n.trackChange(a.id)),n.tree)}incrementRemoteTreeIndex(){this.timeline.remoteTreeIndex+=1}getRemoteIndex(){return this.timeline.remoteTreeIndex-this.timeline.trimmed}getUnconfirmedChangeCount(){return this.timeline.localTreeIndex-this.timeline.remoteTreeIndex}hasChangesForRemote(){let e=this.timeline.remoteTreeIndex+this.localChangesSentToRemote,r=this.timeline.localTreeIndex;return h(e<=r,"inconsistency in getting local changes to send"),e<r}hasOnlyEmptyChangesForRemote(){let e=this.timeline.remoteTreeIndex+this.localChangesSentToRemote,r=this.timeline.localTreeIndex;return e>=r?!0:this.timeline.computeForwardChanges(e,r).length===0}createUpdateToSend(){if(!this.isReady)throw Error("cannot create updates while not ready");if(!this.hasChangesForRemote())return null;let{changes:e,count:r,reasons:n}=this.getForwardChangesForRemote(),s=++this.seq,i={session:this.session,seq:s,changes:e,count:r,reasons:n,confirmed:!1};return this.localUpdatesInFlight.push(i),i}getForwardChangesForRemote(){let e=this.timeline.remoteTreeIndex+this.localChangesSentToRemote,r=this.timeline.localTreeIndex,n=this.timeline.getChangesBetweenEntries(e,r);return this.localChangesSentToRemote+=n.count,n}commitAndCreateUpdate(e=0){h(O.isTest),this.timeline.commitLocalTree();let r=this.createUpdateToSend();return r?Ae(r,e):null}resetTreesForRecovery(){return S.info("reset trees for recovery, remote:",this.getRemoteIndex(),"last index:",this.timeline.localTreeIndex,"number of entries to reapply to remote tree",this.localChangesSentToRemote),this.timeline.resetTreesForRecovery(this.getRemoteIndex(),this.localChangesSentToRemote)}trim(){if(this.timeline.isPartialLoading)return;let e=0;this.timeline.remoteTreeIndex>0?e=this.getRemoteIndex()-100:e=this.timeline.localTreeIndex-this.timeline.trimmed-100,!(e<=75)&&(this.timeline.trimmed+=e,S.debug("trim",e,"new offset:",this.timeline.trimmed,"entries.length:",this.timeline.entries.length),this.timeline.entries.splice(0,e),h(this.timeline.remoteTreeIndex===0||this.getRemoteIndex()>=0,"must have some buffer before remoteTreeIndex"))}};export{$ as a,Fe as b,X as c,Qe as d,Ze as e,tr as f,tt as g,rt as h,vt as i,yt as j,Ct as k,ae as l,W as m,R as n,Ue as o,j as p,Y as q,nr as r,Ve as s,Be as t,We as u};
//# sourceMappingURL=https://app.framerstatic.com/chunk-ZZH45KH5.mjs.map
